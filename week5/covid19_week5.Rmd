---
title: "Covid19_data_anaysis"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
# Set default options to hide warnings, messages, and excessive output
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
 
# Load libraries
suppressPackageStartupMessages({
    library(readr)
    library(stringr)
    library(tidyverse)
    library(lubridate)
    library(kableExtra)
    library(plotly)
    library(dplyr)
    library(lubridate)
    library(scales)
    library(patchwork)
    library(minpack.lm)  # For nonlinear least squares fitting
    library(broom)
    library(zoo)
})
```

## COVID analysis

This document describes the work done on COVID cases dataset for CU Boulder MDS 2025

### Datasources

Data comes from following repository: "<https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/>"

Files are:
-   **Global confirmed cases** "time_series_covid19_confirmed_global.csv"

-   **Global deaths**: "time_series_covid19_deaths_global.csv"

-   **US confirmed cases:** "time_series_covid19_confirmed_US.csv"

-   **Global population**: "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/UID_ISO_FIPS_LookUp_Table.csv"
### Data loading

```{r data_source, echo=FALSE, warning=FALSE}
url_in <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/"

# File names
file_names = c("time_series_covid19_confirmed_US.csv",  
               "time_series_covid19_confirmed_global.csv",
               "time_series_covid19_deaths_global.csv"
               )

# Construct URLs
urls <- str_c(url_in, file_names)
global_cases <- read_csv(urls[2])
US_cases <- read_csv(urls[1])
global_deaths <- read_csv(urls[3])

pop_url <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/UID_ISO_FIPS_LookUp_Table.csv"
population_data <- read_csv(pop_url, col_types = cols(
  Country_Region = col_character(),
  Province_State = col_character(),
  Admin2 = col_character(),
  Population = col_double(),
  LandArea = col_double()
))
# KEEP ONLY NECESARY COLUMNS
population_data <- population_data %>% 
  select(Province_State , 
         `Country_Region`, 
         Admin2, Population)
```

### DATA PRE-PROCESSING

#### Convert from wide to long format
```{r data_pre_processing_convert, echo=FALSE, warning=FALSE}

# GLOBAL CASES
global_cases <- global_cases %>%
  rename("Country_Region" = "Country/Region", "Province_State" = "Province/State")

global_cases <- global_cases %>%
     pivot_longer(
         cols = -c(`Province_State`, `Country_Region`, Lat, Long),
         names_to = "date",
         values_to = "cases"
     ) %>%
     select(-c(Lat, Long)) %>%
     mutate(date = mdy(date)) 
global_cases <- global_cases %>% filter(cases>0)

# GLOBAL DEATHS
global_deaths <- global_deaths %>%
     pivot_longer(
         cols = -c(`Province/State`, `Country/Region`, Lat, Long),
         names_to = "date",
         values_to = "deaths"
     ) %>%
     select(-c(Lat, Long)) %>%
     mutate(date = mdy(date)) 
global_deaths <- global_deaths %>%
rename("Country_Region" = "Country/Region", "Province_State" = "Province/State")
global_deaths <- global_deaths %>% filter(deaths>0)
global <- global_cases %>%
  left_join(global_deaths, by = c("Country_Region", "Province_State", "date"))


# US CASES
US_cases <- US_cases %>% 
  pivot_longer(cols=-(UID:Combined_Key), names_to="date", values_to = "cases")%>%
  select(Admin2:cases) %>%
  mutate(date=mdy(date)) %>%
  select(-c(Lat, Long_))
US_cases <- US_cases %>% filter(cases>0)

```

#### JOIN WITH POPULATION TO SCALE POPULATION PER MILLION 
```{r data_pre_processing_merge, echo=FALSE, warning=FALSE}

# Normalize global cases by population percentage

global <- global_cases %>%
   left_join(global_deaths, by = c("Province_State", "Country_Region", "date"))

global <- global %>%
  left_join(population_data, by = c("Country_Region", "Province_State")) %>%
  mutate(infected_percentage = (cases / Population) * 1e6)
global <- global %>%
  mutate(date = as.Date(date, tryFormats = c("%Y-%m-%d", "%m/%d/%Y", "%d-%m-%Y")))

# Normalize US cases by population percentage
US <- US_cases %>%
  left_join(population_data, by = c("Country_Region", "Province_State", "Admin2")) %>%
  mutate(infected_percentage = (cases/ Population) * 1e6)
US <- US %>%
  mutate(date = as.Date(date, tryFormats = c("%Y-%m-%d", "%m/%d/%Y", "%d-%m-%Y")))

# Filter data
filtered_global <- global %>%
  filter(!is.na(infected_percentage)) %>%  # Keep only valid percentage values
  select(Country_Region, Province_State, date, cases, infected_percentage) %>%  # Keep relevant columns
  arrange(Country_Region, date)

# Clean NA
global <- global %>%
  filter(!is.na(deaths))

```


### INSIGHTS
#### COMPUTE THE VIRULENCY OF THE COVID-19 BY THE SPREAD RATE

\text{Spread Rate} = \frac{\text{Final Cases}}{\text{Average Cases Per Month}}

```{r data_compute_spread_rate, echo=FALSE, warning=FALSE}

final_cases_per_country <- filtered_global %>%
  filter(date == max(date)) %>%
  group_by(Country_Region) %>%
  summarize(final_cases = sum(cases, na.rm = TRUE)) %>%
  ungroup()

# Step 2: Compute Monthly Cases Per Country
monthly_cases <- filtered_global %>%
  mutate(month = floor_date(date, "month")) %>%
  group_by(Country_Region, month) %>%
  summarize(monthly_cases = sum(cases, na.rm = TRUE)) %>%
  arrange(Country_Region, month) %>%
  ungroup()

# Step 3: Compute Previous Month Cases for Virulence Ratio
monthly_cases_lagged <- monthly_cases %>%
  group_by(Country_Region) %>%
  mutate(prev_month_cases = lag(monthly_cases)) %>%  # Shifted cases for previous month
  mutate(prev_month_cases = ifelse(is.na(prev_month_cases) | prev_month_cases == 0, 1, prev_month_cases)) %>% 
  ungroup()

# Step 4: Compute Virulence Ratio (Relative Monthly Spread Speed)
spread_trajectory <- monthly_cases_lagged %>%
  left_join(final_cases_per_country, by = "Country_Region") %>%
  mutate(virulence_ratio = (monthly_cases - prev_month_cases) / prev_month_cases) %>%
  mutate(virulence_ratio = ifelse(is.infinite(virulence_ratio) | is.nan(virulence_ratio), NA, virulence_ratio)) %>%
  mutate(virulence_ratio = ifelse(virulence_ratio > 1, 1, virulence_ratio)) %>%  # Cap at 1 if necessary
  filter(!is.na(virulence_ratio)) 

# Step 5: Ensure No Infinite or NaN Values
spread_trajectory <- spread_trajectory %>%
  mutate(virulence_ratio = ifelse(is.infinite(virulence_ratio) | is.nan(virulence_ratio), NA, virulence_ratio))

spread_trajectory <- spread_trajectory %>%
  left_join(population_data, by = "Country_Region") %>%  # Ensure population data is present
  mutate(infected_percentage = (monthly_cases / Population) * 1e6)  # Normalize by population


```



#### VISUALIZE VIRUS SPREAD TRAJECTORIES
```{r data_pre_processing_merge, echo=FALSE, warning=FALSE, fig.width=14, fig.height=6, }

top_countries <- spread_trajectory %>%
  group_by(Country_Region) %>%
  summarize(total_infected_per_million = sum(infected_percentage, na.rm = TRUE)) %>%
  arrange(desc(total_infected_per_million)) %>%  # Sort by highest normalized infections
  slice_head(n = 10)  

# Step 2: Ensure Only These Top 10 Countries Are Used for Processing
filtered_spread <- spread_trajectory %>%
  filter(Country_Region %in% top_countries$Country_Region) %>%  # Apply the filter
  arrange(Country_Region, month)  # Ensure chronological order

# Step 3: Apply a 3-Month Moving Average for Smoothing
filtered_spread <- filtered_spread %>%
  group_by(Country_Region) %>%
  mutate(virulence_ratio_smooth = rollmean(virulence_ratio, k = 3, fill = NA, align = "right")) %>%
  ungroup()

# Step 4: Plot the Smoothed Virulence Ratio for Top 10 Countries
 p<- ggplot(filtered_spread, aes(x = month, y = virulence_ratio_smooth, 
                            color = Country_Region, group = Country_Region)) +
  geom_line(size = 1) +
  scale_x_date(date_breaks = "3 months", date_labels = "%b %Y") +
  scale_color_brewer(palette = "Paired") +  # Better color differentiation
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title = "Top 10 Countries: Smoothed Virulence Ratio Over Time",
       x = "Month",
       y = "Virulence Ratio (Smoothed)",
       color = "Country")

print(p)
```

#### PLOT THE DEATHS TRAJECTORY FOR THE TOP 10 COUNTRIES 
```{r analysis_of_virulency_and_deaths_correlation, echo=FALSE, message=FALSE, warning=FALSE, fig.width=14, fig.height=8, }
  library(plotly)

  spread_with_deaths <- spread_trajectory %>%
     left_join(global, by = c("Country_Region" = "Country_Region", "month" = "date")) %>%
  select(Country_Region, month, virulence_ratio, deaths) 
  
  top_10_countries <- top_countries$Country_Region 
  filtered_data <- spread_with_deaths %>%
    filter(Country_Region %in% top_10_countries)
  
p <- ggplot(filtered_data, aes(x = month, y = deaths, color = virulence_ratio)) +
  geom_point(size = 3, alpha = 0.8) +  # Scatter points
  scale_color_viridis_c() +  # Better color differentiation
  facet_wrap(~ Country_Region, scales = "free") +  # Create small multiples for each country
  theme_minimal() +
  labs(title = "Virulence vs. Deaths Over Time (Faceted by Country)",
       x = "Month",
       y = "Total Deaths",
       color = "Virulence Ratio") +
  theme(legend.position = "right",
        axis.text.x = element_text(angle = 90, hjust = 1))

# Convert to an interactive Plotly plot
ggplotly(p)
```

  
  
  
